<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Halı Stok - V7 (Advanced Invoice)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #121212;
            --text-color: #e0e0e0;
            --accent-color: #ffffff;
            --border-color: #333;
            --input-bg: #1e1e1e;
            --success: #2e7d32;
            --danger: #c62828;
            --info: #0288d1;
            --warning: #f57c00;
            --border-radius: 8px;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0;
            background: var(--bg-color); color: var(--text-color); position: relative; min-height: 100vh;}
        
        #bg-watermark {
            position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50%; height: auto; opacity: 0.1; z-index: -1; pointer-events: none;
            display: none;
        }

        .app-container { display: flex; flex-direction: column; height: 100vh; position: relative;
            z-index: 1;}
        .header { background: #000; border-bottom: 1px solid var(--border-color); padding: 15px;
            display: flex; justify-content: space-between; align-items: center; }
        .logo-area { font-size: 1.2rem; font-weight: bold;
            display: flex; align-items: center; gap: 10px; color: #fff; }
        .logo-img { height: 40px;
            width: auto; background: white; padding: 2px; border-radius: 4px; }
        
        .main-content { flex: 1;
            overflow-y: auto; padding: 15px; }
        
        .nav-bar { background: var(--card-bg);
            border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; position: sticky; bottom: 0;
        }
        .nav-item { border: none; background: none; font-size: 0.8rem; display: flex; flex-direction: column;
            align-items: center; cursor: pointer; color: #777; }
        .nav-item.active { color: var(--accent-color); font-weight: bold;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px;
        }

        .card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 15px;
            margin-bottom: 15px; }
        .btn { background: var(--accent-color); color: #000; border: none;
            padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            transition: 0.2s;}
        .btn:hover { opacity: 0.8;
        }
        .btn-danger { background: var(--danger); color: #fff;
        }
        .btn-success { background: var(--success); color: #fff;
        }
        .btn-info { background: var(--info); color: #fff;
        }
        .btn-outline { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color);
        }
        .btn-block { width: 100%; display: block; margin-top: 5px;
        }
        
        input, select, textarea { width: 100%;
            padding: 10px; margin-bottom: 10px; background: var(--input-bg); border: 1px solid var(--border-color); color: #fff; border-radius: 4px; box-sizing: border-box;
        }
        
        .grid-2 { display: grid;
            grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid;
            grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        table { width: 100%;
            border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th, td { text-align: left;
            padding: 8px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background: #1f1f1f;
            color: #fff; font-weight: 600; }
        tr:hover { background: #1a1a1a;
        }

        .stock-item { display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px;
            overflow: hidden; margin-bottom: 10px; background: var(--card-bg);}
        .stock-header { padding: 10px; background: #1f1f1f;
            font-weight: bold; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color);
        }
        .stock-body { padding: 10px; display: flex; gap: 10px; align-items: center;
        }
        .stock-img { width: 100px; height: 100px; object-fit: cover; border-radius: 4px;
            border: 1px solid #333; cursor: pointer;} 
        .stock-details { flex: 1; font-size: 0.9rem;
        }
        .stock-actions { padding: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 5px;
            justify-content: flex-end; }
        
        .stat-box { text-align: center;
            padding: 15px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px;
        }
        .stat-val { font-size: 1.4rem; font-weight: bold; display: block; color: #fff;
        }
        .stat-lbl { font-size: 0.8rem; color: #aaa;
        }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%;
            height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal.active { display: flex;
        }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 8px; width: 95%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; position: relative; border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .close-modal { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; cursor: pointer;
            color: #fff; }

        .hidden { display: none !important;
        }
        
        .print-preview-box { background: #fff;
            color: #000; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 10px;
        }
        .print-preview-box img { max-width: 100%;
        }
        #reader { width: 100%; border: 2px solid #fff;
        }
        
        .mgmt-list-item { display: flex;
            justify-content: space-between; padding: 8px; background: #222; margin-bottom: 5px; border-radius: 4px; align-items: center;
        }
        .table-img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px;
            border: 1px solid #444; }
        
        .section-title { color: var(--accent-color);
            border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; font-size: 1.1rem;
        }
    </style>
</head>
<body>

<img id="bg-watermark" src="" alt="Watermark">

<div class="app-container">
    <header class="header">
        <div class="logo-area">
            <img src="" id="headerLogo" class="logo-img hidden">
            <span id="headerCompanyName">HALI STOK V7</span>
        </div>
        <div class="lang-select">
            <select id="langSelect" onchange="changeLanguage()" style="padding: 5px; width: auto; margin:0; background: #333; color: #fff;">
                <option value="tr">TR</option>
                <option value="en">EN</option>
                <option value="sq">SQ</option>
                <option value="mk">MK</option>
            </select>
        </div>
    </header>

    <div id="mainArea" class="main-content">
        
        <div id="page-dashboard" class="page">
            <div class="grid-2">
                <div class="stat-box"><span class="stat-val" id="dashTotalStock">0</span><span class="stat-lbl" data-tr="toplam_stok">Toplam Stok</span></div>
                <div class="stat-box"><span class="stat-val" id="dashTotalM2">0 m²</span><span class="stat-lbl" data-tr="toplam_m2">Toplam m²</span></div>
                <div class="stat-box"><span class="stat-val" id="dashDailySale">€0</span><span class="stat-lbl" data-tr="gunluk_ciro">Günlük Ciro</span></div>
                <div class="stat-box"><span class="stat-val" id="dashMonthlySale">€0</span><span class="stat-lbl" data-tr="aylik_ciro">Aylık Ciro</span></div>
            </div>
            
            <div class="card" style="margin-top:15px;">
                <h3 data-tr="stok_detaylari">Stok Detayları</h3>
                <div class="grid-2">
                    <div>
                        <h4 class="section-title" data-tr="materyal_analizi">Materyal Analizi</h4>
                        <div id="dashMaterialList"></div>
                    </div>
                    <div>
                        <h4 class="section-title" data-tr="ebat_analizi">Ebat Analizi</h4>
                        <div id="dashSizeList"></div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:15px;">
                <h3 data-tr="grafik_analizi">Grafik Analizi</h3>
                <canvas id="salesChart" style="background: #eee; border-radius: 4px; padding: 5px;"></canvas>
            </div>
        </div>

        <div id="page-stock" class="page hidden">
            <div class="card">
                <div class="grid-2">
                    <input type="text" id="searchStock" data-placeholder="ara_placeholder" placeholder="Kod veya İsim Ara..." onkeyup="renderStock()">
                    <button class="btn" onclick="openModal('modalAddProduct')"><i class="fas fa-plus"></i> <span data-tr="urun_ekle">Ekle</span></button>
                </div>
                <button class="btn btn-outline btn-block" onclick="startScanner('search')"><i class="fas fa-camera"></i> <span data-tr="barkod_tara">Barkod Tara</span></button>
            </div>
            <div id="stockList"></div>
        </div>

        <div id="page-sales" class="page hidden">
            <div class="card">
                <h3 data-tr="finans_yonetimi">Finans Yönetimi</h3>
                <div class="grid-2">
                     <button class="btn btn-info" onclick="openModal('modalBalanceSheet')"><i class="fas fa-calendar-alt"></i> <span data-tr="bilanco_gecmisi">Bilanço Geçmişi</span></button>
                     <button class="btn btn-outline" onclick="openModal('modalExpenses')"><i class="fas fa-minus-circle"></i> <span data-tr="gider_ekle">Gider Ekle</span></button>
                </div>
                
                <h4 class="section-title" style="margin-top:15px;" data-tr="satis_listesi">Satış Listesi (Gelir)</h4>
                <div id="salesListContainer"></div>

                <h4 class="section-title" style="margin-top:15px;" data-tr="gider_listesi">Gider Listesi</h4>
                <div id="expensesListContainer"></div>
            </div>
        </div>
        
        <div id="page-customers" class="page hidden">
            <div class="card">
                <div class="grid-2">
                    <input type="text" id="searchCustomer" data-placeholder="musteri_ara" placeholder="Müşteri Ara..." onkeyup="renderCustomers()">
                    <button class="btn" onclick="openModal('modalAddCustomer')"><i class="fas fa-plus"></i> <span data-tr="ekle">Ekle</span></button>
                </div>
            </div>
            <div id="customerList"></div>
        </div>

        <div id="page-settings" class="page hidden">
            <div class="card">
                <h3 data-tr="yonetim">Yönetim</h3>
                <button class="btn btn-block btn-outline" onclick="openModal('modalDefinitions')"><i class="fas fa-list"></i> <span data-tr="materyal_ebat_yonetimi">Materyal & Ebat Yönetimi</span></button>
                
                <h3 data-tr="patron_paneli">Patron Paneli</h3>
                <button class="btn btn-block" onclick="openModal('modalCompany')"><i class="fas fa-building"></i> <span data-tr="firma_bilgileri">Firma Bilgileri</span></button>
                <button class="btn btn-block" onclick="exportReport('full')"><i class="fas fa-file-pdf"></i> <span data-tr="tam_rapor">Tam Rapor</span></button>
                <button class="btn btn-block" onclick="openArchive()"><i class="fas fa-archive"></i> <span data-tr="arsiv_yil_sonu">Arşiv & Yıl Sonu</span></button>
                
                <h3 data-tr="veri_yonetimi">Veri Yönetimi</h3>
                <button class="btn btn-block btn-outline" onclick="backupData()"><i class="fas fa-download"></i> <span data-tr="yedek_indir">Yedek İndir</span></button>
                <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
                <button class="btn btn-block btn-outline" onclick="document.getElementById('restoreFile').click()"><i class="fas fa-upload"></i> <span data-tr="yedek_yukle">Yedek Yükle</span></button>
                <button class="btn btn-block btn-danger" onclick="resetSystem()"><i class="fas fa-trash"></i> <span data-tr="sistemi_sifirla">Sistemi Sıfırla</span></button>
                
                <h3 data-tr="admin_sifresi">Admin Şifresi</h3>
                <input type="password" id="newAdminPass" data-placeholder="yeni_sifre" placeholder="Yeni Şifre">
                <button class="btn btn-block" onclick="changeAdminPass()"><span data-tr="degistir">Değiştir</span></button>

                <h3 data-tr="arka_plan_resmi">Arka Plan Resmi</h3>
                <input type="file" accept="image/*" onchange="setBackgroundImage(this)">
                <button class="btn btn-danger btn-block" onclick="clearBackgroundImage()" data-tr="arka_plan_temizle">Arka Planı Temizle</button>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="showPage('dashboard')"><i class="fas fa-chart-line"></i> <span data-tr="panel">Panel</span></button>
        <button class="nav-item" onclick="showPage('stock')"><i class="fas fa-boxes"></i> <span data-tr="stok">Stok</span></button>
        <button class="nav-item" onclick="showPage('sales')"><i class="fas fa-receipt"></i> <span data-tr="kasa">Kasa</span></button>
        <button class="nav-item" onclick="showPage('customers')"><i class="fas fa-users"></i> <span data-tr="musteriler">Müşteriler</span></button>
        <button class="nav-item" onclick="showPage('settings')"><i class="fas fa-cog"></i> <span data-tr="ayarlar">Ayarlar</span></button>
    </nav>
</div>

<div id="modalAddProduct" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('modalAddProduct')">&times;</span>
        <h3 id="modalProductTitle" data-tr="urun_ekle">Ürün Ekle</h3>
        <input type="hidden" id="prodId">
        <input type="text" id="prodCode" data-placeholder="urun_kodu" placeholder="Ürün Kodu">
        <div class="grid-2">
            <button class="btn btn-outline" onclick="generateBarcode()"><i class="fas fa-barcode"></i> <span data-tr="barkod_uret">Barkod Üret</span></button>
            <button class="btn btn-outline" onclick="startScanner('prod')"><i class="fas fa-camera"></i> <span data-tr="kamera">Kamera</span></button>
        </div>
        <img id="barcodePreview" style="display:none; width:100%; margin:10px 0; background:#fff; padding:5px;">
        
        <label data-tr="materyal">Materyal</label>
        <select id="prodMaterial"></select>
        
        <label data-tr="ebat_sablonu">Ebat Şablonu</label>
        <select id="prodSizePreset" onchange="applySizePreset()">
            <option value="">Özel Ebat Gir</option>
        </select>

        <div class="grid-2">
            <input type="number" id="prodWidth" placeholder="En (cm)" oninput="calcM2()">
            <input type="number" id="prodLength" placeholder="Boy (cm)" oninput="calcM2()">
        </div>
        <div style="text-align:right; font-weight:bold; margin-bottom:10px; color:#aaa;">
            <span id="prodM2Display">0</span> m²
        </div>
        
        <label data-tr="fotograf">Fotoğraf:</label>
        <input type="file" id="prodPhotoInput" accept="image/*" onchange="previewImage(this)">
        <img id="prodPhotoPreview" style="width:100px; height:100px; object-fit:cover; display:none; border:1px solid #555; margin-top:5px;">

        <div class="grid-2">
            <div>
                <label data-tr="dukkan_stok">Dükkan Stok</label>
                <input type="number" id="prodStockShop" value="0">
            </div>
            <div>
                <label data-tr="depo_stok">Depo Stok</label>
                <input type="number" id="prodStockDepot" value="0">
            </div>
        </div>

        <button class="btn btn-block btn-success" onclick="saveProduct()" data-tr="kaydet">Kaydet</button>
    </div>
</div>

<div id="modalDefinitions" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('modalDefinitions')">&times;</span>
        <h3 data-tr="materyal_ebat_yonetimi">Materyal ve Ebat Yönetimi</h3>
        
        <h4 data-tr="materyaller">Materyaller</h4>
        <div class="grid-2">
            <input type="text" id="newMatName" placeholder="Yeni Materyal">
            <button class="btn" onclick="addMaterial()" data-tr="ekle">Ekle</button>
        </div>
        <div id="listMaterials" style="max-height:150px; overflow-y:auto; border:1px solid #333; padding:5px; margin-bottom:15px;"></div>

        <h4 data-tr="ebatlar">Ebatlar</h4>
        <div class="grid-3">
            <input type="number" id="newSizeW" placeholder="En">
            <input type="number" id="newSizeL" placeholder="Boy">
            <button class="btn" onclick="addSize()" data-tr="ekle">Ekle</button>
        </div>
        <div id="listSizes" style="max-height:150px; overflow-y:auto; border:1px solid #333; padding:5px;"></div>
    </div>
</div>

<div id="modalTransaction" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('modalTransaction')">&times;</span>
        <h3 data-tr="islem_yap">İşlem Yap</h3>
        <input type="hidden" id="transProdId">
        <h4 id="transProdName"></h4>
        
        <label data-tr="islem_tipi">İşlem Tipi</label>
        <select id="transType" onchange="toggleTransFields()">
            <option value="sale_retail" data-tr="perakende_satis">Perakende Satış</option>
            <option value="sale_wholesale" data-tr="toptan_satis">Toptan Satış</option>
            <option value="waste" data-tr="zayi">Zayi / Eksilme</option>
            <option value="add" data-tr="stok_ekle">Stok Ekle</option>
        </select>

        <label data-tr="konum">Konum</label>
        <select id="transLocation">
            <option value="shop" data-tr="dukkan">Dükkan</option>
            <option value="depot" data-tr="depo">Depo</option>
        </select>

        <div id="divCustomer" class="hidden">
            <label data-tr="musteri_sec">Müşteri Seç</label>
            <select id="transCustomer"></select>
        </div>

        <div class="grid-2">
            <input type="number" id="transQty" placeholder="Adet" value="1" oninput="calcTransTotal()">
            <input type="number" id="transPriceM2" placeholder="Fiyat (m² başına)" oninput="calcTransTotal()">
        </div>
        
        <div style="font-size:1.2rem; font-weight:bold; text-align:right; margin:10px 0;">
            <span data-tr="toplam">Toplam</span>: <span id="transTotal">€0</span>
        </div>

        <div id="divAdminPass" class="hidden">
            <input type="password" id="transAdminPass" data-placeholder="admin_sifresi" placeholder="Admin Şifresi">
        </div>

        <button class="btn btn-block btn-success" onclick="processTransaction()" data-tr="onayla">Onayla</button>
    </div>
</div>

<div id="modalScanner" class="modal">
    <div class="modal-content" style="background:#000; color:#fff;">
        <span class="close-modal" onclick="stopScanner()" style="color:#fff;">&times;</span>
        <div id="reader"></div>
        <p id="scannerStatus" style="text-align:center;" data-tr="kamera_baslatiliyor">Kamera Başlatılıyor...</p>
    </div>
</div>

<div id="modalExpenses" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('modalExpenses')">&times;</span>
        <h3 data-tr="gider_ekle">Gider Ekle</h3>
        <input type="date" id="expDate">
        <input type="text" id="expDesc" data-placeholder="aciklama" placeholder="Açıklama">
        <input type="number" id="expAmount" data-placeholder="tutar" placeholder="Tutar (€)">
        <button class="btn btn-block" onclick="saveExpense()" data-tr="kaydet">Kaydet</button>
    </div>
</div>

<div id="modalAddCustomer" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('modalAddCustomer')">&times;</span>
        <h3 data-tr="musteri_ekle">Müşteri Ekle</h3>
        <input type="text" id="custName" data-placeholder="ad_soyad" placeholder="Ad Soyad / Firma">
        <input type="text" id="custPhone" data-placeholder="telefon" placeholder="Telefon">
        <input type="text" id="custAddress" data-placeholder="adres" placeholder="Adres">
        <button class="btn btn-block" onclick="saveCustomer()" data-tr="kaydet">Kaydet</button>
    </div>
</div>

<div id="modalCompany" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('modalCompany')">&times;</span>
        <h3 data-tr="firma_bilgileri">Firma Bilgileri</h3>
        <input type="text" id="compName" data-placeholder="firma_adi" placeholder="Firma Adı">
        <label data-tr="logo">Logo:</label>
        <input type="file" id="compLogoInput" onchange="previewLogo(this)">
        <button class="btn btn-block" onclick="saveCompany()" data-tr="kaydet">Kaydet</button>
    </div>
</div>

<div id="modalBalanceSheet" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <span class="close-modal" onclick="closeModal('modalBalanceSheet')">&times;</span>
        <h3 data-tr="bilanco_gecmisi">Bilanço Geçmişi</h3>
        <div id="balanceSheetContent"></div>
    </div>
</div>

<div id="modalPrintBarcode" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('modalPrintBarcode')">&times;</span>
        <h3 data-tr="barkod_yazdir">Barkod Yazdır</h3>
        <div id="printAreaBarcode" class="print-preview-box">
            <h3 id="printCompName" style="margin:5px 0;"></h3>
            <img id="printProductImg" style="width:100px; height:100px; object-fit:contain; margin:5px 0; display:none;">
            <br>
            <img id="printBarcodeImg" style="width:100%; max-width:200px;">
            <h4 id="printBarcodeCode" style="margin:5px 0;"></h4>
            <p id="printBarcodeDetails" style="font-size:12px; margin:0;"></p>
        </div>
        <button class="btn btn-block" onclick="printBarcodeElement()" data-tr="yazdir">Yazdır</button>
    </div>
</div>

<script>
    // --- INDEXEDDB (FOTOĞRAFLAR İÇİN) ---
    const DB_NAME = 'HaliStokDB';
    const DB_VERSION = 1;
    let db;

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('images')) db.createObjectStore('images', { keyPath: 'id' });
            };
            request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            request.onerror = (e) => reject(e);
        });
    }

    async function saveImageToDB(id, base64) {
        if (!db) await initDB();
        const tx = db.transaction('images', 'readwrite');
        tx.objectStore('images').put({ id: id, data: base64 });
    }

    async function getImageFromDB(id) {
        if (!db) await initDB();
        return new Promise((resolve) => {
            const tx = db.transaction('images', 'readonly');
            const req = tx.objectStore('images').get(id);
            req.onsuccess = (e) => resolve(e.target.result ? e.target.result.data : null);
            req.onerror = () => resolve(null);
        });
    }
    
    async function deleteImageFromDB(id) {
        if (!db) await initDB();
        db.transaction('images', 'readwrite').objectStore('images').delete(id);
    }

    // --- GLOBAL VERİLER ---
    let data = {
        products: [],
        transactions: [], 
        customers: [],
        expenses: [],
        materials: ['Akrilik', 'Bambu', 'Viskon', 'Polyester', 'Yün'],
        sizes: ['80x150', '80x300', '100x200', '100x300', '120x180', '160x230', '200x290'],
        settings: {
            shopName: 'Halı Dünyası',
            logo: '',
            bgImage: '',
            adminPass: '1234', 
            currency: '€'
        },
        archive: [] 
    };

    // --- DİL YÖNETİMİ ---
    let currentLang = 'tr';
    const langDict = {
        tr: {
            panel: "Panel", stok: "Stok", kasa: "Kasa", musteriler: "Müşteriler", ayarlar: "Ayarlar",
            toplam_stok: "Toplam Stok", toplam_m2: "Toplam m²", gunluk_ciro: "Günlük Ciro", aylik_ciro: "Aylık Ciro",
            stok_detaylari: "Stok Detayları", materyal_analizi: "Materyal Analizi", ebat_analizi: "Ebat Analizi",
            grafik_analizi: "Grafik Analizi", urun_ekle: "Ürün Ekle", ekle: "Ekle", barkod_tara: "Barkod Tara",
            finans_yonetimi: "Finans Yönetimi", bilanco_gecmisi: "Bilanço Geçmişi", gider_ekle: "Gider Ekle",
            satis_listesi: "Satış Listesi (Gelir)", gider_listesi: "Gider Listesi",
            materyal_ebat_yonetimi: "Materyal & Ebat Yönetimi", patron_paneli: "Patron Paneli", firma_bilgileri: "Firma Bilgileri",
            tam_rapor: "Tam Rapor", arsiv_yil_sonu: "Arşiv & Yıl Sonu", veri_yonetimi: "Veri Yönetimi",
            yedek_indir: "Yedek İndir", yedek_yukle: "Yedek Yükle", sistemi_sifirla: "Sistemi Sıfırla",
            admin_sifresi: "Admin Şifresi", degistir: "Değiştir", arka_plan_resmi: "Arka Plan Resmi", arka_plan_temizle: "Arka Planı Temizle",
            barkod_uret: "Barkod Üret", kamera: "Kamera", materyal: "Materyal", ebat_sablonu: "Ebat Şablonu",
            fotograf: "Fotoğraf", dukkan_stok: "Dükkan Stok", depo_stok: "Depo Stok", kaydet: "Kaydet",
            materyaller: "Materyaller", ebatlar: "Ebatlar", islem_yap: "İşlem Yap", islem_tipi: "İşlem Tipi",
            perakende_satis: "Perakende Satış", toptan_satis: "Toptan Satış", zayi: "Zayi / Eksilme", stok_ekle: "Stok Ekle",
            konum: "Konum", dukkan: "Dükkan", depo: "Depo", musteri_sec: "Müşteri Seç", toplam: "Toplam", onayla: "Onayla",
            kamera_baslatiliyor: "Kamera Başlatılıyor...", musteri_ekle: "Müşteri Ekle", firma_adi: "Firma Adı", logo: "Logo",
            barkod_yazdir: "Barkod Yazdır", yazdir: "Yazdır", yonetim: "Yönetim",
            ara_placeholder: "Kod veya İsim Ara...", musteri_ara: "Müşteri Ara...", ad_soyad: "Ad Soyad / Firma", telefon: "Telefon", adres: "Adres",
            urun_kodu: "Ürün Kodu", aciklama: "Açıklama", tutar: "Tutar", yeni_sifre: "Yeni Şifre",
            fis_indir: "Fiş İndir", tarih: "Tarih", tip: "Tip", urun: "Ürün", fiyat: "Fiyat", islem: "İşlem",
            alert_kod_gir: "Önce kod giriniz!", alert_mevcut: "Bu barkod zaten var!", alert_eksik: "Zorunlu alanları doldurun!",
            alert_stok_yetersiz: "Yetersiz Stok!", alert_sifre_yanlis: "Şifre Yanlış!", alert_musteri_sec: "Müşteri Seçilmedi!",
            alert_basarili: "İşlem Başarılı", sil_onay: "Silmek için Admin Şifresi:", yil_sonu_onay: "Yıl kapatılsın mı?",
            sifirla_onay: "TÜM VERİLER SİLİNECEK! Emin misiniz?", adet: "Adet", m2_fiyat: "m² Fiyatı", satis_m2: "Satılan m²"
        },
        en: {
            panel: "Dashboard", stok: "Stock", kasa: "Cash", musteriler: "Customers", ayarlar: "Settings",
            toplam_stok: "Total Stock", toplam_m2: "Total m²", gunluk_ciro: "Daily Income", aylik_ciro: "Monthly Income",
            stok_detaylari: "Stock Details", materyal_analizi: "Material Analysis", ebat_analizi: "Size Analysis",
            grafik_analizi: "Chart Analysis", urun_ekle: "Add Product", ekle: "Add", barkod_tara: "Scan Barcode",
            finans_yonetimi: "Finance Mgmt", bilanco_gecmisi: "Balance History", gider_ekle: "Add Expense",
            satis_listesi: "Sales List (Income)", gider_listesi: "Expense List",
            materyal_ebat_yonetimi: "Mat & Size Mgmt", patron_paneli: "Boss Panel", firma_bilgileri: "Company Info",
            tam_rapor: "Full Report", arsiv_yil_sonu: "Archive & Year End", veri_yonetimi: "Data Mgmt",
            yedek_indir: "Download Backup", yedek_yukle: "Restore Backup", sistemi_sifirla: "Reset System",
            admin_sifresi: "Admin Password", degistir: "Change", arka_plan_resmi: "Background Image", arka_plan_temizle: "Clear Background",
            barkod_uret: "Gen. Barcode", kamera: "Camera", materyal: "Material", ebat_sablonu: "Size Preset",
            fotograf: "Photo", dukkan_stok: "Shop Stock", depo_stok: "Depot Stock", kaydet: "Save",
            materyaller: "Materials", ebatlar: "Sizes", islem_yap: "Transaction", islem_tipi: "Type",
            perakende_satis: "Retail Sale", toptan_satis: "Wholesale", zayi: "Waste/Loss", stok_ekle: "Add Stock",
            konum: "Location", dukkan: "Shop", depo: "Depot", musteri_sec: "Select Customer", toplam: "Total", onayla: "Confirm",
            kamera_baslatiliyor: "Camera Starting...", musteri_ekle: "Add Customer", firma_adi: "Company Name", logo: "Logo",
            barkod_yazdir: "Print Barcode", yazdir: "Print", yonetim: "Management",
            ara_placeholder: "Search Code/Name...", musteri_ara: "Search Customer...", ad_soyad: "Name / Company", telefon: "Phone", adres: "Address",
            urun_kodu: "Product Code", aciklama: "Description", tutar: "Amount", yeni_sifre: "New Password",
            fis_indir: "Download Receipt", tarih: "Date", tip: "Type", urun: "Product", fiyat: "Price", islem: "Action",
            alert_kod_gir: "Enter code first!", alert_mevcut: "Barcode exists!", alert_eksik: "Fill required fields!",
            alert_stok_yetersiz: "Insufficient Stock!", alert_sifre_yanlis: "Wrong Password!", alert_musteri_sec: "Select Customer!",
            alert_basarili: "Success", sil_onay: "Admin Pass to Delete:", yil_sonu_onay: "Close the year?",
            sifirla_onay: "ALL DATA WILL BE DELETED! Sure?", adet: "Qty", m2_fiyat: "Price/m²", satis_m2: "Sold m²"
        },
        sq: {
            panel: "Paneli", stok: "Stoku", kasa: "Arka", musteriler: "Klientët", ayarlar: "Cilësimet",
            toplam_stok: "Totali i Stokut", toplam_m2: "Totali m²", gunluk_ciro: "Xhiro Ditore", aylik_ciro: "Xhiro Mujore",
            stok_detaylari: "Detajet e Stokut", materyal_analizi: "Analiza e Materialit", ebat_analizi: "Analiza e Madhësisë",
            grafik_analizi: "Analiza Grafike", urun_ekle: "Shto Produkt", ekle: "Shto", barkod_tara: "Skano Barkod",
            finans_yonetimi: "Menaxhimi Financiar", bilanco_gecmisi: "Bilanci Historik", gider_ekle: "Shto Shpenzim",
            satis_listesi: "Lista e Shitjeve", gider_listesi: "Lista e Shpenzimeve",
            materyal_ebat_yonetimi: "Menaxhimi Material/Madhësi", patron_paneli: "Paneli i Pronarit", firma_bilgileri: "Informacioni i Kompanisë",
            tam_rapor: "Raport i Plotë", arsiv_yil_sonu: "Arkivi & Fundviti", veri_yonetimi: "Menaxhimi i Të Dhënave",
            yedek_indir: "Shkarko Rezervë", yedek_yukle: "Rivendo Rezervë", sistemi_sifirla: "Rivendo Sistemin",
            admin_sifresi: "Fjalëkalimi Admin", degistir: "Ndrysho", arka_plan_resmi: "Imazhi i Sfondit", arka_plan_temizle: "Pastro Sfondin",
            barkod_uret: "Gjenero Barkod", kamera: "Kamera", materyal: "Materiali", ebat_sablonu: "Modeli i Madhësisë",
            fotograf: "Foto", dukkan_stok: "Stoku Dyqan", depo_stok: "Stoku Depo", kaydet: "Ruaj",
            materyaller: "Materialet", ebatlar: "Madhësitë", islem_yap: "Transaksion", islem_tipi: "Lloji",
            perakende_satis: "Shitje me Pakicë", toptan_satis: "Shitje me Shumicë", zayi: "Humbje", stok_ekle: "Shto Stok",
            konum: "Vendndodhja", dukkan: "Dyqan", depo: "Depo", musteri_sec: "Zgjidh Klientin", toplam: "Totali", onayla: "Konfirmo",
            kamera_baslatiliyor: "Kamera po fillon...", musteri_ekle: "Shto Klient", firma_adi: "Emri i Kompanisë", logo: "Logo",
            barkod_yazdir: "Printo Barkod", yazdir: "Printo", yonetim: "Menaxhimi",
            ara_placeholder: "Kërko...", musteri_ara: "Kërko Klient...", ad_soyad: "Emri / Kompania", telefon: "Telefon", adres: "Adresa",
            urun_kodu: "Kodi i Produktit", aciklama: "Përshkrimi", tutar: "Shuma", yeni_sifre: "Fjalëkalimi i Ri",
            fis_indir: "Shkarko Faturën", tarih: "Data", tip: "Lloji", urun: "Produkti", fiyat: "Çmimi", islem: "Veprimi",
            alert_kod_gir: "Shkruaj kodin!", alert_mevcut: "Barkodi ekziston!", alert_eksik: "Plotësoni fushat!",
            alert_stok_yetersiz: "Stok i pamjaftueshëm!", alert_sifre_yanlis: "Fjalëkalimi Gabim!", alert_musteri_sec: "Zgjidh Klientin!",
            alert_basarili: "Sukses", sil_onay: "Admin për të fshirë:", yil_sonu_onay: "Mbyll vitin?",
            sifirla_onay: "TE GJITHA TE DHENAT DO FSHIHEN! I sigurt?", adet: "Sasia", m2_fiyat: "Çmimi/m²", satis_m2: "m² e Shitur"
        },
        mk: {
            panel: "Табла", stok: "Акција", kasa: "Пари", musteriler: "Клиенти", ayarlar: "Поставки",
            toplam_stok: "Вкупно Акции", toplam_m2: "Вкупно m²", gunluk_ciro: "Дневен Промет", aylik_ciro: "Месечен Промет",
            stok_detaylari: "Детали за Акцијата", materyal_analizi: "Анализа на Материјал", ebat_analizi: "Анализа на Големина",
            grafik_analizi: "Графичка Анализа", urun_ekle: "Додај Производ", ekle: "Додај", barkod_tara: "Скенирај Баркод",
            finans_yonetimi: "Финансии", bilanco_gecmisi: "Историја на Биланс", gider_ekle: "Додај Трошок",
            satis_listesi: "Листа на Продажба", gider_listesi: "Листа на Трошоци",
            materyal_ebat_yonetimi: "Управување со Материјали", patron_paneli: "Шеф Панел", firma_bilgileri: "Инфо за Компанијата",
            tam_rapor: "Целосен Извештај", arsiv_yil_sonu: "Архива и Крај на Година", veri_yonetimi: "Управување со Податоци",
            yedek_indir: "Преземи Резервна Копија", yedek_yukle: "Врати Резервна Копија", sistemi_sifirla: "Ресетирај Систем",
            admin_sifresi: "Админ Лозинка", degistir: "Промени", arka_plan_resmi: "Слика за позадина", arka_plan_temizle: "Исчисти позадина",
            barkod_uret: "Генерирај Баркод", kamera: "Камера", materyal: "Материјал", ebat_sablonu: "Шаблон за Големина",
            fotograf: "Фото", dukkan_stok: "Продавница", depo_stok: "Магацин", kaydet: "Зачувај",
            materyaller: "Материјали", ebatlar: "Големини", islem_yap: "Трансакција", islem_tipi: "Тип",
            perakende_satis: "Продажба на мало", toptan_satis: "Трговија на големо", zayi: "Загуба", stok_ekle: "Додај Акција",
            konum: "Локација", dukkan: "Продавница", depo: "Магацин", musteri_sec: "Избери Клиент", toplam: "Вкупно", onayla: "Потврди",
            kamera_baslatiliyor: "Камерата се вклучува...", musteri_ekle: "Додај Клиент", firma_adi: "Име на Компанија", logo: "Лого",
            barkod_yazdir: "Печати Баркод", yazdir: "Печати", yonetim: "Управување",
            ara_placeholder: "Барај...", musteri_ara: "Барај Клиент...", ad_soyad: "Име / Компанија", telefon: "Телефон", adres: "Адреса",
            urun_kodu: "Шифра", aciklama: "Опис", tutar: "Износ", yeni_sifre: "Нова Лозинка",
            fis_indir: "Преземи Сметка", tarih: "Датум", tip: "Тип", urun: "Производ", fiyat: "Цена", islem: "Акција",
            alert_kod_gir: "Внесете шифра!", alert_mevcut: "Баркодот постои!", alert_eksik: "Пополнете полиња!",
            alert_stok_yetersiz: "Нема доволно залиха!", alert_sifre_yanlis: "Грешна Лозинка!", alert_musteri_sec: "Избери Клиент!",
            alert_basarili: "Успешно", sil_onay: "Админ Лозинка за бришење:", yil_sonu_onay: "Затвори година?",
            sifirla_onay: "СИТЕ ПОДАТОЦИ ЌЕ СЕ ИЗБРИШАТ! Сигурен?", adet: "Количина", m2_fiyat: "Цена/m²", satis_m2: "Продадено m²"
        }
    };

    function t(key) { return langDict[currentLang][key] || key; }

    // --- BAŞLANGIÇ & YÜKLEME ---
    window.onload = async function() {
        await initDB();
        loadData();
        applySettings();
        showPage('dashboard');
        updateDashboard();
        renderStock();
        changeLanguage();
    };

    function loadData() {
        const stored = localStorage.getItem('haliStokV7'); 
        if (stored) {
            const parsed = JSON.parse(stored);
            data = { ...data, ...parsed };
            if(!data.materials) data.materials = ['Akrilik', 'Bambu'];
            if(!data.sizes) data.sizes = ['80x150', '120x180'];
        }
    }

    function saveData() {
        try { localStorage.setItem('haliStokV7', JSON.stringify(data)); }
        catch (e) { alert("Hafıza Doldu!"); }
    }

    function applySettings() {
        if(data.settings.logo) {
            const el = document.getElementById('headerLogo');
            el.src = data.settings.logo;
            el.classList.remove('hidden');
        }
        document.getElementById('headerCompanyName').innerText = data.settings.shopName;
        if(data.settings.bgImage) {
            const bg = document.getElementById('bg-watermark');
            bg.src = data.settings.bgImage;
            bg.style.display = 'block';
        }
    }

    // --- SAYFA YÖNETİMİ ---
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.remove('hidden');
        
        if(pageId === 'dashboard') updateDashboard();
        if(pageId === 'stock') renderStock();
        if(pageId === 'sales') renderSales();
        if(pageId === 'customers') renderCustomers();
    }

    function openModal(id) {
        document.getElementById(id).classList.add('active');
        if(id === 'modalAddProduct') resetProdModal();
        if(id === 'modalTransaction') { renderCustomerSelect(); toggleTransFields(); }
        if(id === 'modalDefinitions') renderDefinitions();
        if(id === 'modalBalanceSheet') renderBalanceSheet();
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        stopScanner();
    }
    
    // --- STOK & ÜRÜN ---
    function resetProdModal() {
        document.getElementById('prodId').value = '';
        document.getElementById('prodCode').value = '';
        populateProdSelects();
        document.getElementById('prodWidth').value = '';
        document.getElementById('prodLength').value = '';
        document.getElementById('prodStockShop').value = 0;
        document.getElementById('prodStockDepot').value = 0;
        document.getElementById('prodPhotoPreview').style.display = 'none';
        document.getElementById('prodPhotoInput').value = '';
        document.getElementById('barcodePreview').style.display = 'none';
        document.getElementById('prodM2Display').innerText = '0';
    }

    function populateProdSelects() {
        const matSel = document.getElementById('prodMaterial');
        matSel.innerHTML = `<option value="">${t('materyal')}</option>`;
        data.materials.forEach(m => matSel.innerHTML += `<option value="${m}">${m}</option>`);

        const sizeSel = document.getElementById('prodSizePreset');
        sizeSel.innerHTML = '<option value="">Özel Ebat Gir</option>';
        data.sizes.forEach(s => sizeSel.innerHTML += `<option value="${s}">${s}</option>`);
    }

    function applySizePreset() {
        const val = document.getElementById('prodSizePreset').value;
        if(val) {
            const parts = val.toLowerCase().split('x');
            if(parts.length === 2) {
                document.getElementById('prodWidth').value = parts[0].trim();
                document.getElementById('prodLength').value = parts[1].trim();
                calcM2();
            }
        }
    }
    
    function calcM2() {
        const w = parseFloat(document.getElementById('prodWidth').value) || 0;
        const l = parseFloat(document.getElementById('prodLength').value) || 0;
        const m2 = (w * l) / 10000;
        document.getElementById('prodM2Display').innerText = m2.toFixed(2);
    }
    
    let tempPhotoBase64 = null;
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                tempPhotoBase64 = e.target.result;
                document.getElementById('prodPhotoPreview').src = e.target.result;
                document.getElementById('prodPhotoPreview').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveProduct() {
        const id = document.getElementById('prodId').value || Date.now().toString();
        const code = document.getElementById('prodCode').value;
        if(data.products.some(p => p.code === code && p.id !== id)) return alert(t('alert_mevcut'));

        const mat = document.getElementById('prodMaterial').value;
        const w = parseFloat(document.getElementById('prodWidth').value);
        const l = parseFloat(document.getElementById('prodLength').value);
        if(!code || !mat || !w || !l) return alert(t('alert_eksik'));
        let hasPhoto = false;
        if (tempPhotoBase64) {
            await saveImageToDB(id, tempPhotoBase64);
            hasPhoto = true; tempPhotoBase64 = null;
        } else {
             const oldP = data.products.find(p => p.id === id);
             if(oldP && oldP.hasPhoto) hasPhoto = true;
        }

        const product = { 
            id, code, material: mat, width: w, length: l, 
            m2: ((w * l) / 10000).toFixed(2), 
            stockShop: parseInt(document.getElementById('prodStockShop').value), 
            stockDepot: parseInt(document.getElementById('prodStockDepot').value), 
            hasPhoto, barcode: document.getElementById('barcodePreview').src 
        };

        const existIndex = data.products.findIndex(p => p.id === id);
        if(existIndex > -1) data.products[existIndex] = product;
        else data.products.push(product);
        
        saveData(); closeModal('modalAddProduct'); renderStock();
    }

    function renderStock() {
        const list = document.getElementById('stockList');
        const search = document.getElementById('searchStock').value.toLowerCase();
        list.innerHTML = '';

        data.products.forEach(p => {
            if(p.code.toLowerCase().includes(search) || p.material.toLowerCase().includes(search)) {
                const totalStock = parseInt(p.stockShop) + parseInt(p.stockDepot);
                const totalM2 = (totalStock * parseFloat(p.m2)).toFixed(2);
                const div = document.createElement('div');
               
                div.className = 'stock-item';
                div.innerHTML = `
                    <div class="stock-header"><span>${p.code}</span><span>${p.width}x${p.length} (${p.m2} m²)</span></div>
                    <div class="stock-body">
                        <img src="https://via.placeholder.com/100?text=..." id="img-stock-${p.id}" class="stock-img" onclick="showImageFull('${p.id}')">
                        <div class="stock-details">
                            <strong>${p.material}</strong><br>
                            ${t('dukkan')}: ${p.stockShop} | ${t('depo')}: ${p.stockDepot}<br>
                            <span style="color:#2196F3">${t('toplam')}: ${totalStock} (${totalM2} m²)</span>
                        </div>
                    </div>
                    <div class="stock-actions">
                         <button class="btn btn-outline" onclick="printBarcode('${p.id}')"><i class="fas fa-print"></i></button>
                         <button class="btn btn-success" onclick="openTransaction('${p.id}', 'add')"><i class="fas fa-plus"></i></button>
                         <button class="btn btn-danger" onclick="openTransaction('${p.id}', 'sale')"><i class="fas fa-minus"></i></button>
                         <button class="btn" onclick="editProduct('${p.id}')"><i class="fas fa-edit"></i></button>
                         <button class="btn btn-danger" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>`;
                list.appendChild(div);
                if(p.hasPhoto) getImageFromDB(p.id).then(d => { if(d) document.getElementById(`img-stock-${p.id}`).src = d; });
            }
        });
    }

    // --- İŞLEMLER (SATIŞ/EKLEME) ---
    let currentTransProdId = null;
    function openTransaction(id, type) {
        currentTransProdId = id;
        const p = data.products.find(x => x.id === id);
        document.getElementById('transProdName').innerText = `${p.code} - ${p.material} (${p.width}x${p.length})`;
        document.getElementById('transProdId').value = id;
        document.getElementById('transType').value = (type === 'add') ? 'add' : 'sale_retail';
        toggleTransFields();
        openModal('modalTransaction');
    }

    function toggleTransFields() {
        const type = document.getElementById('transType').value;
        const divCust = document.getElementById('divCustomer');
        const divPass = document.getElementById('divAdminPass');
        const priceInput = document.getElementById('transPriceM2');
        
        divCust.classList.add('hidden');
        divPass.classList.add('hidden');
        priceInput.disabled = false;
        if(type === 'sale_wholesale') divCust.classList.remove('hidden');
        
        if (type === 'waste') {
            divPass.classList.remove('hidden');
            priceInput.value = 0; priceInput.disabled = true;
        } else if (type === 'add') {
             priceInput.disabled = true;
             priceInput.value = 0;
        }
        calcTransTotal();
    }

    function calcTransTotal() {
        const qty = parseFloat(document.getElementById('transQty').value) || 0;
        const price = parseFloat(document.getElementById('transPriceM2').value) || 0;
        const p = data.products.find(x => x.id === currentTransProdId);
        if(p) {
            const m2 = parseFloat(p.m2);
            const total = qty * m2 * price;
            document.getElementById('transTotal').innerText = data.settings.currency + total.toFixed(2);
        }
    }

    function processTransaction() {
        const type = document.getElementById('transType').value;
        const loc = document.getElementById('transLocation').value;
        const qty = parseInt(document.getElementById('transQty').value);
        const priceM2 = parseFloat(document.getElementById('transPriceM2').value) || 0;
        const p = data.products.find(x => x.id === currentTransProdId);
        const custName = document.getElementById('transCustomer').value;
        const pass = document.getElementById('transAdminPass').value;
        if(qty <= 0) return alert("Adet > 0 olmalı");
        if(type === 'waste' && pass !== data.settings.adminPass) return alert(t('alert_sifre_yanlis'));
        if(type === 'sale_wholesale' && !custName) return alert(t('alert_musteri_sec'));
        
        const currentStock = loc === 'shop' ? p.stockShop : p.stockDepot;
        if(type !== 'add' && currentStock < qty) return alert(t('alert_stok_yetersiz'));

        if(type === 'add') {
            if(loc === 'shop') p.stockShop += qty;
            else p.stockDepot += qty;
        } else {
            if(loc === 'shop') p.stockShop -= qty;
            else p.stockDepot -= qty;
        }

        const m2Total = parseFloat(p.m2) * qty;
        const totalMoney = m2Total * priceM2;

        const trans = {
            id: Date.now(),
            date: new Date().toISOString(),
            type, prodId: p.id, prodCode: p.code, prodName: p.material,
            location: loc, qty, m2: m2Total.toFixed(2), price: totalMoney,
            unitPrice: priceM2,
            customer: (type === 'sale_wholesale') ? custName : '',
            details: `${p.width}x${p.length}`
        };
        if(type !== 'add') data.transactions.push(trans);
        saveData(); closeModal('modalTransaction'); renderStock(); updateDashboard();
        alert(t('alert_basarili'));
    }

    // --- FİNANS & RAPORLAMA ---
    function renderSales() {
        const salesContainer = document.getElementById('salesListContainer');
        const expensesContainer = document.getElementById('expensesListContainer');
        
        // SATIŞLAR TABLOSU
        let salesHtml = `<div style="overflow-x:auto;"><table class="card" style="min-width: 800px;">
            <tr>
                <th>${t('tarih')}</th>
                <th>Müşteri</th>
                <th>${t('materyal')}</th>
                <th>Ebat</th>
                <th>${t('adet')}</th>
                <th>${t('m2_fiyat')}</th>
                <th>Toplam m²</th>
                <th>Toplam Tutar</th>
                <th>${t('islem')}</th>
            </tr>`;
            
        const sales = data.transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 50);
        
        sales.forEach(tr => {
             let color = tr.type === 'waste' ? 'orange' : '#43a047';
             let custDisplay = (tr.type === 'sale_wholesale' && tr.customer) ? tr.customer : '-';
             
             salesHtml += `<tr style="color:${color}">
                <td>${tr.date.slice(0,10)}</td>
                <td>${custDisplay}</td>
                <td>${tr.prodName}</td>
                <td>${tr.details}</td>
                <td>${tr.qty}</td>
                <td>${data.settings.currency}${parseFloat(tr.unitPrice).toFixed(2)}</td>
                <td>${tr.m2} m²</td>
                <td style="font-weight:bold">${data.settings.currency}${parseFloat(tr.price).toFixed(2)}</td>
                <td style="display:flex; gap:5px; border-bottom:none;">
                    <button class="btn btn-info btn-outline" style="padding:4px 8px; font-size:0.8rem;" onclick="generateInvoicePDF(${tr.id})" title="PDF Fatura İndir"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn btn-danger btn-outline" style="padding:4px 8px; font-size:0.8rem;" onclick="deleteItem(${tr.id}, false)" title="Satışı Sil"><i class="fas fa-trash"></i></button>
                </td>
             </tr>`;
        });
        salesHtml += '</table></div>';
        salesContainer.innerHTML = salesHtml;

        // GİDERLER TABLOSU 
        let expHtml = `<div style="overflow-x:auto;"><table class="card"><tr><th>${t('tarih')}</th><th>${t('aciklama')}</th><th>${t('tutar')}</th><th>${t('islem')}</th></tr>`;
        const exps = data.expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 50);
        exps.forEach(e => {
            expHtml += `<tr style="color:#e53935">
                <td>${e.date}</td>
                <td>${e.desc}</td>
                <td style="font-weight:bold">${data.settings.currency}${parseFloat(e.amount).toFixed(2)}</td>
                <td><button class="btn btn-danger btn-outline" style="padding:4px 8px;" onclick="deleteItem(${e.id}, true)" title="Gideri Sil"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        });
        expHtml += '</table></div>';
        expensesContainer.innerHTML = expHtml;
    }

    // --- PDF OLUŞTURMA (PDF İÇİN 4 DİLE ÖZEL HARF DÜZELTMESİ EKLENDİ) ---
    async function generateInvoicePDF(transId) {
        const tr = data.transactions.find(t => t.id === transId);
        if(!tr) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Türkçe, Kiril (MK), Arnavutça ve Özel Simgeleri PDF Fontuna Uyumlu Hale Getiren Fonksiyon
        function s(val) {
            if (val === null || val === undefined) return '';
            let text = val.toString();
            const map = {
                // Türkçe
                'ş': 's', 'Ş': 'S', 'ı': 'i', 'İ': 'I', 'ğ': 'g', 'Ğ': 'G', 'ö': 'o', 'Ö': 'O', 'ç': 'c', 'Ç': 'C', 'ü': 'u', 'Ü': 'U',
                // Arnavutça
                'ë': 'e', 'Ë': 'E',
                // Makedonca (Kiril)
                'а':'a', 'б':'b', 'в':'v', 'г':'g', 'д':'d', 'ѓ':'gj', 'е':'e', 'ж':'zh', 'з':'z', 'ѕ':'dz', 'и':'i', 'ј':'j', 'к':'k', 'л':'l', 'љ':'lj', 'м':'m', 'н':'n', 'њ':'nj', 'о':'o', 'п':'p', 'р':'r', 'с':'s', 'т':'t', 'ќ':'kj', 'у':'u', 'ф':'f', 'х':'h', 'ц':'c', 'ч':'ch', 'џ':'dzh', 'ш':'sh',
                'А':'A', 'Б':'B', 'В':'V', 'Г':'G', 'Д':'D', 'Ѓ':'Gj', 'Е':'E', 'Ж':'Zh', 'З':'Z', 'Ѕ':'Dz', 'И':'I', 'Ј':'J', 'К':'K', 'Л':'L', 'Љ':'Lj', 'М':'M', 'Н':'N', 'Њ':'Nj', 'О':'O', 'П':'P', 'Р':'R', 'С':'S', 'Т':'T', 'Ќ':'Kj', 'У':'U', 'Ф':'F', 'Х':'H', 'Ц':'C', 'Ч':'Ch', 'Џ':'Dzh', 'Ш':'Sh',
                // Simgeler
                '₺': 'TL', '€': 'EUR', '₽': 'RUB', '£': 'GBP', '²': '2', '&': '+'
            };
            return text.replace(/[şŞıİğĞöÖçÇüÜëËа-шА-ШѓЃѕЅјЈљЉњЊќЌџЏ₺€₽£²&]/g, char => map[char] || char);
        }

        // Arka Plan Resmi Fligran Olarak Ekleme
        if(data.settings.bgImage) {
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            doc.setGState(new doc.GState({opacity: 0.1})); 
            doc.addImage(data.settings.bgImage, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            doc.setGState(new doc.GState({opacity: 1.0})); 
        }

        // Logo
        if(data.settings.logo) {
            doc.addImage(data.settings.logo, 'JPEG', 15, 10, 30, 30);
        }

        // Firma Bilgileri ve Fatura Başlığı (Artık s() fonksiyonu ile korunuyor)
        doc.setFontSize(22);
        doc.text(s(data.settings.shopName), 105, 25, null, null, "center");
        
        doc.setFontSize(14);
        const typeLabel = tr.type === 'sale_wholesale' ? t('toptan_satis') : t('perakende_satis');
        doc.text(s(`FATURA / INVOICE (${typeLabel})`), 105, 35, null, null, "center");
        
        doc.setFontSize(10);
        doc.text(s(`${t('tarih')}: ${tr.date.slice(0,10)}`), 14, 50);
        if(tr.type === 'sale_wholesale' && tr.customer) {
            doc.text(s(`Musteri Adi: ${tr.customer}`), 14, 55);
        }

        // Tablo Hazırlığı
        const headers = [[s('Malzeme'), s('Ebat'), s('Adet'), s('m2 Fiyati'), s('Toplam m2'), s('Toplam Tutar')]];
        const body = [[
            s(tr.prodName), 
            s(tr.details), 
            s(tr.qty), 
            s(data.settings.currency) + parseFloat(tr.unitPrice).toFixed(2), 
            s(tr.m2) + " m2", 
            s(data.settings.currency) + tr.price.toFixed(2)
        ]];

        doc.autoTable({
            startY: 65,
            head: headers,
            body: body,
            theme: 'striped',
            headStyles: { fillColor: [30, 30, 30] },
            styles: { fontSize: 10, cellPadding: 3 }
        });
        
        let finalY = doc.lastAutoTable.finalY + 10;

        // Toplam Tutar Alanı
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(s(`${t('toplam')}: ${data.settings.currency}${tr.price.toFixed(2)}`), 190, finalY + 10, null, null, "right");

        // PDF'i Kaydetme
        doc.save(`Fatura_${s(tr.prodCode || 'Satis')}_${tr.id}.pdf`);
    }

    function renderBalanceSheet() {
        const content = document.getElementById('balanceSheetContent');
        let months = {};
        
        data.transactions.forEach(t => {
            if(t.type.includes('sale')) {
                const m = t.date.slice(0, 7);
                if(!months[m]) months[m] = { income: 0, expense: 0 };
                months[m].income += t.price;
            }
        });

        data.expenses.forEach(e => {
            const m = e.date.slice(0, 7);
            if(!months[m]) months[m] = { income: 0, expense: 0 };
            months[m].expense += parseFloat(e.amount);
        });
        let html = `<table class="card">
            <tr><th>Ay</th><th style="color:#4caf50">Gelir</th><th style="color:#f44336">Gider</th><th>Net Kâr</th></tr>`;
        Object.keys(months).sort().reverse().forEach(m => {
            const row = months[m];
            const net = row.income - row.expense;
            const netColor = net >= 0 ? '#4caf50' : '#f44336';
            html += `<tr>
                <td>${m}</td>
                <td>${data.settings.currency}${row.income.toFixed(2)}</td>
                <td>${data.settings.currency}${row.expense.toFixed(2)}</td>
                <td style="color:${netColor}; font-weight:bold">${data.settings.currency}${net.toFixed(2)}</td>
            </tr>`;
        });
        html += `</table>`;
        content.innerHTML = html;
    }

    // --- DİĞER FONKSİYONLAR ---
    function updateDashboard() {
        let totalStock = 0, totalM2 = 0;
        let matCount = {}, sizeCount = {};
        
        data.products.forEach(p => {
            const s = p.stockShop + p.stockDepot;
            totalStock += s; totalM2 += s * parseFloat(p.m2);
            matCount[p.material] = (matCount[p.material] || 0) + s;
            const sz = `${p.width}x${p.length}`;
            sizeCount[sz] = (sizeCount[sz] || 0) + s;
        });

        document.getElementById('dashTotalStock').innerText = totalStock;
        document.getElementById('dashTotalM2').innerText = totalM2.toFixed(2) + " m²";

        const today = new Date().toISOString().slice(0,10);
        const month = today.slice(0,7);
        let daily = 0, monthly = 0;
        data.transactions.forEach(t => {
            if(t.type.includes('sale')) {
                if(t.date.slice(0,10) === today) daily += t.price;
                if(t.date.startsWith(month)) monthly += t.price;
            }
        });
        document.getElementById('dashDailySale').innerText = data.settings.currency + daily.toFixed(2);
        document.getElementById('dashMonthlySale').innerText = data.settings.currency + monthly.toFixed(2);
        
        document.getElementById('dashMaterialList').innerHTML = objToTable(matCount);
        document.getElementById('dashSizeList').innerHTML = objToTable(sizeCount);
        
        renderChart();
    }

    function objToTable(obj) {
        let h = '<table style="font-size:0.8rem"><tr><th>Tip</th><th>Adet</th></tr>';
        for(let k in obj) h += `<tr><td>${k}</td><td>${obj[k]}</td></tr>`;
        return h + '</table>';
    }
    
    function changeLanguage() {
        currentLang = document.getElementById('langSelect').value;
        const dict = langDict[currentLang];
        document.querySelectorAll('[data-tr]').forEach(el => {
            const key = el.getAttribute('data-tr');
            if(dict[key]) el.innerText = dict[key];
        });
        document.querySelectorAll('[data-placeholder]').forEach(el => {
            const key = el.getAttribute('data-placeholder');
            if(dict[key]) el.placeholder = dict[key];
        });
        const activePage = document.querySelector('.page:not(.hidden)').id.replace('page-', '');
        showPage(activePage);
    }
    
    function setBackgroundImage(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                data.settings.bgImage = e.target.result;
                saveData(); applySettings();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    function clearBackgroundImage() {
        data.settings.bgImage = '';
        document.getElementById('bg-watermark').style.display = 'none';
        saveData();
    }
    
    function renderCustomerSelect() {
        const sel = document.getElementById('transCustomer');
        sel.innerHTML = `<option value="">${t('musteri_sec')}</option>`;
        data.customers.forEach(c => sel.innerHTML += `<option value="${c.name}">${c.name}</option>`);
    }

    function generateBarcode() {
        const code = document.getElementById('prodCode').value;
        if(!code) return alert(t('alert_kod_gir'));
        const canvas = document.createElement('canvas');
        JsBarcode(canvas, code, {format: "CODE128", width: 2, height: 50, displayValue: true});
        document.getElementById('barcodePreview').src = canvas.toDataURL("image/png");
        document.getElementById('barcodePreview').style.display = 'block';
    }

    function saveExpense() {
        const amt = parseFloat(document.getElementById('expAmount').value);
        if(!amt) return;
        data.expenses.push({ id: Date.now(), date: document.getElementById('expDate').value || new Date().toISOString().slice(0,10), desc: document.getElementById('expDesc').value, amount: amt });
        saveData(); closeModal('modalExpenses'); renderSales();
    }
    
    function deleteItem(id, isExp) {
        if(prompt(t('sil_onay')) === data.settings.adminPass) {
            if(isExp) data.expenses = data.expenses.filter(e => e.id !== id);
            else {
                const t = data.transactions.find(x => x.id === id);
                if(t && t.type !== 'waste') {
                    const p = data.products.find(x => x.id === t.prodId);
                    if(p) {
                        if(t.location === 'shop') p.stockShop += t.qty;
                        else p.stockDepot += t.qty;
                    }
                }
                data.transactions = data.transactions.filter(x => x.id !== id);
            }
            saveData(); renderSales(); updateDashboard(); renderStock();
        } else alert(t('alert_sifre_yanlis'));
    }
    
    function renderDefinitions() {
        document.getElementById('listMaterials').innerHTML = data.materials.map((m,i) => `<div class="mgmt-list-item"><span>${m}</span><button class="btn btn-danger btn-outline" style="padding:2px 5px" onclick="deleteMaterial(${i})">X</button></div>`).join('');
        document.getElementById('listSizes').innerHTML = data.sizes.map((s,i) => `<div class="mgmt-list-item"><span>${s}</span><button class="btn btn-danger btn-outline" style="padding:2px 5px" onclick="deleteSize(${i})">X</button></div>`).join('');
    }
    function addMaterial() { const v = document.getElementById('newMatName').value; if(v){ data.materials.push(v); saveData(); renderDefinitions();
    } }
    function deleteMaterial(i) { data.materials.splice(i,1); saveData(); renderDefinitions();
    }
    function addSize() { const w=document.getElementById('newSizeW').value, l=document.getElementById('newSizeL').value; if(w&&l){ data.sizes.push(w+'x'+l); saveData(); renderDefinitions();
    } }
    function deleteSize(i) { data.sizes.splice(i,1); saveData(); renderDefinitions();
    }
    
    let scanner;
    function startScanner(m) {
        document.getElementById('modalScanner').classList.add('active');
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            stopScanner();
            if(m==='prod') document.getElementById('prodCode').value = txt;
            if(m==='search') { document.getElementById('searchStock').value = txt; showPage('stock'); renderStock(); }
        });
    }
    function stopScanner() { if(scanner) scanner.stop().then(()=>scanner.clear()); document.getElementById('modalScanner').classList.remove('active'); }

    let chartInst;
    function renderChart() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        if(chartInst) chartInst.destroy();
        const sales = data.transactions.filter(t=>t.type.includes('sale')).slice(-10);
        chartInst = new Chart(ctx, { type: 'line', data: { labels: sales.map(t=>t.date.slice(5,10)), datasets: [{ label: 'Satış', data: sales.map(t=>t.price), borderColor: '#fff' }] } });
    }

    function backupData() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download='yedek.json'; a.click();
    }
    function restoreData(input) { const r=new FileReader(); r.onload=e=>{ data=JSON.parse(e.target.result); saveData(); location.reload(); }; r.readAsText(input.files[0]);
    }
    function resetSystem() { if(confirm(t('sifirla_onay'))) { localStorage.removeItem('haliStokV7'); location.reload();
    } }

    function saveCustomer() { const n = document.getElementById('custName').value; if(n){ data.customers.push({id:Date.now(), name:n, phone:document.getElementById('custPhone').value, address:document.getElementById('custAddress').value}); saveData(); closeModal('modalAddCustomer'); renderCustomers();
    } }
    function renderCustomers() { 
        const s = document.getElementById('searchCustomer').value.toLowerCase();
        document.getElementById('customerList').innerHTML = data.customers.filter(c=>c.name.toLowerCase().includes(s)).map(c=>`<div class="mgmt-list-item"><span>${c.name} - ${c.phone}</span><button class="btn btn-danger" onclick="delCustomer(${c.id})">Sil</button></div>`).join('');
    }
    function delCustomer(id) { if(prompt(t('sil_onay'))===data.settings.adminPass){ data.customers=data.customers.filter(c=>c.id!==id); saveData(); renderCustomers();
    } }
    function saveCompany() { data.settings.shopName = document.getElementById('compName').value; saveData(); location.reload();
    }
    function previewLogo(i) { const r = new FileReader(); r.onload=e=>{data.settings.logo=e.target.result;}; r.readAsDataURL(i.files[0]);
    }
    function changeAdminPass() { if(prompt("Eski:")===data.settings.adminPass){ data.settings.adminPass=document.getElementById('newAdminPass').value; saveData(); alert(t('alert_basarili'));
    } }
    
    function exportReport(type) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        function s(val) {
            if (val === null || val === undefined) return '';
            let text = val.toString();
            const map = {
                'ş':'s', 'Ş':'S', 'ı':'i', 'İ':'I', 'ğ':'g', 'Ğ':'G', 'ö':'o', 'Ö':'O', 'ç':'c', 'Ç':'C', 'ü':'u', 'Ü':'U',
                'ë':'e', 'Ë':'E',
                'а':'a', 'б':'b', 'в':'v', 'г':'g', 'д':'d', 'ѓ':'gj', 'е':'e', 'ж':'zh', 'з':'z', 'ѕ':'dz', 'и':'i', 'ј':'j', 'к':'k', 'л':'l', 'љ':'lj', 'м':'m', 'н':'n', 'њ':'nj', 'о':'o', 'п':'p', 'р':'r', 'с':'s', 'т':'t', 'ќ':'kj', 'у':'u', 'ф':'f', 'х':'h', 'ц':'c', 'ч':'ch', 'џ':'dzh', 'ш':'sh',
                'А':'A', 'Б':'B', 'В':'V', 'Г':'G', 'Д':'D', 'Ѓ':'Gj', 'Е':'E', 'Ж':'Zh', 'З':'Z', 'Ѕ':'Dz', 'И':'I', 'Ј':'J', 'К':'K', 'Л':'L', 'Љ':'Lj', 'М':'M', 'Н':'N', 'Њ':'Nj', 'О':'O', 'П':'P', 'Р':'R', 'С':'S', 'Т':'T', 'Ќ':'Kj', 'У':'U', 'Ф':'F', 'Х':'H', 'Ц':'C', 'Ч':'Ch', 'Џ':'Dzh', 'Ш':'Sh',
                '₺':'TL', '€':'EUR', '₽':'RUB', '£':'GBP', '²':'2', '&':'+'
            };
            return text.replace(/[şŞıİğĞöÖçÇüÜëËа-шА-ШѓЃѕЅјЈљЉњЊќЌџЏ₺€₽£²&]/g, char => map[char] || char);
        }

        doc.text(s(data.settings.shopName), 10, 10);
        const body = data.products.map(p => [s(p.code), s(p.material), s(p.width+'x'+p.length), (p.stockShop+p.stockDepot).toString(), s(p.m2)]);
        doc.autoTable({ head: [[s(t('urun_kodu')), s(t('materyal')), 'Ebat', 'Stok', 'M2']], body: body, startY: 20 });
        doc.save('Rapor.pdf');
    }
    
    function openArchive() { if(confirm(t('yil_sonu_onay')) && prompt("Pass:")===data.settings.adminPass) { data.archive.push({year:new Date().getFullYear(), data:{...data}}); data.transactions=[]; data.expenses=[]; saveData(); location.reload();
    } }
    
    async function editProduct(id) {
        const p = data.products.find(x => x.id === id);
        openModal('modalAddProduct');
        document.getElementById('prodId').value = p.id;
        document.getElementById('prodCode').value = p.code;
        document.getElementById('prodMaterial').value = p.material;
        document.getElementById('prodWidth').value = p.width;
        document.getElementById('prodLength').value = p.length;
        document.getElementById('prodStockShop').value = p.stockShop;
        document.getElementById('prodStockDepot').value = p.stockDepot;
        calcM2();
        if(p.hasPhoto) { const d = await getImageFromDB(p.id); if(d) { document.getElementById('prodPhotoPreview').src=d; document.getElementById('prodPhotoPreview').style.display='block';
        } }
    }
    function deleteProduct(id) { if(prompt(t('sil_onay'))===data.settings.adminPass){ data.products=data.products.filter(p=>p.id!==id); deleteImageFromDB(id); saveData(); renderStock();
    } }
    function showImageFull(id) { const i=document.getElementById(`img-stock-${id}`); if(i && !i.src.includes('placeholder')) window.open(i.src);
    }
    
    function printBarcode(id) {
        const p = data.products.find(x => x.id === id);
        document.getElementById('printCompName').innerText = data.settings.shopName;
        document.getElementById('printBarcodeCode').innerText = p.code;
        document.getElementById('printBarcodeDetails').innerText = `${p.material} | ${p.width}x${p.length} cm`;
        
        const canvas = document.createElement('canvas');
        JsBarcode(canvas, p.code, {format: "CODE128", width: 3, height: 80, displayValue: false});
        document.getElementById('printBarcodeImg').src = canvas.toDataURL();
        openModal('modalPrintBarcode');
    }
    
    function printBarcodeElement() {
        const content = document.getElementById('printAreaBarcode').innerHTML;
        const win = window.open('', '', 'height=600,width=600');
        win.document.write('<html><head><style>body{text-align:center; font-family:sans-serif;} img{max-width:100%;}</style></head><body>');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        setTimeout(() => win.print(), 500);
    }
</script>
</body>
</html>